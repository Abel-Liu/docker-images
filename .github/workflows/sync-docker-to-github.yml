name: sync-docker-to-github

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: "docker镜像 英文逗号分开"
        required: true

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

jobs:
  sync:
    name: pull and push
    runs-on: ubuntu-latest

    steps:
      - name: Clean up Docker to free space
        run: |
          docker system prune -a -f
          docker volume prune -f

      - name: Get env
        run: |
          echo "REGISTRY=ghcr.io" >> $GITHUB_ENV
          repo_name=`echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]'`
          echo "REPO_NAME=$repo_name" >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: push
        run: |
          images="${{ github.event.inputs.docker_images }}"
          IFS=',' read -r -a image_array <<< "$images"

          for image in "${image_array[@]}"; do
            echo "image: $image"
            repo=$(echo $image)        #去除空格
            if [[ $repo =~ ":" ]]; then
              tag=${repo##*:}         #如果包含:，截取冒号后边
            else
              tag=latest              #不包含冒号，即没有写tag
            fi
            repo=${repo%:*}           #去除:后边的

            echo "Syncing repo: $repo, tag: $tag"

            docker pull $image
            docker tag $image ${{ env.REGISTRY }}/$repo:$tag
            docker push ${{ env.REGISTRY }}/$repo:$tag
          done
